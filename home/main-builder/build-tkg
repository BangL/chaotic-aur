#!/usr/bin/env bash
export TKGLOGS='/srv/http/chaotic-aur/makepkglogs/_daily/tkg'
mkdir -p "$TKGLOGS"

# Wine helpers
wine_setup() {
	git checkout customization.cfg PKGBUILD

	export _USE_DXVKGI='true'
	if [ "$3" = 'true' ]; then
		export _USE_DXVKGI='false'
	fi

	sed -i'' "
	s/_COMPILEWITH=\"[^\"]*\"/_COMPILEWITH=\"zapcc\"/g
	s/_OPTIONAL_MARCHFLAG=\"[^\"]*\"/_OPTIONAL_MARCHFLAG=\"\"/g
	s/_NUKR=\"[^\"]*\"/_NUKR=\"false\"/g
	s/_NOINITIALPROMPT=\"[^\"]*\"/_NOINITIALPROMPT=\"true\"/g
	s/_use_staging=\"[^\"]*\"/_use_staging=\"$1\"/g
	s/_use_pba=\"[^\"]*\"/_use_pba=\"$2\"/g
	s/_use_vkd3d=\"[^\"]*\"/_use_vkd3d=\"$3\"/g
	s/_dxvk_dxgi=\"[^\"]*\"/_dxvk_dxgi=\"$_USE_DXVKGI\"/g
	s/_use_faudio=\"[^\"]*\"/_use_faudio=\"$4\"/g
	" customization.cfg

	local _SRCINFO=$(makepkg -o --noprepare --printsrcinfo)
	export _PKGNAME=$(echo "$_SRCINFO" | grep -Po '(?<=pkgname = )(.*)$')

	echo "[build-tkg] customization setted to: ${_PKGNAME}"
}

kernel_setup() {
	git checkout customization.cfg PKGBUILD

	sed --debug -i'' "
	s/_NUKR=\"[^\"]*\"/_NUKR=\"false\"/g
	s/_modprobeddb=\"[^\"]*\"/_modprobeddb=\"false\"/g
	s/_menuconfig=\"[^\"]*\"/_menuconfig=\"false\"/g
	s/_cpusched=\"[^\"]*\"/_cpusched=\"pds\"/g
	s/_sched_yield_type=\"[^\"]*\"/_sched_yield_type=\"0\"/g
	s/_ftracedisable=\"[^\"]*\"/_ftracedisable=\"true\"/g
	s/_numadisable=\"[^\"]*\"/_numadisable=\"true\"/g
	s/_full_tickless=\"[^\"]*\"/_full_tickless=\"true\"/g
	s/_voluntary_preempt=\"[^\"]*\"/_voluntary_preempt=\"true\"/g
	s/_acs_override=\"[^\"]*\"/_acs_override=\"true\"/g
	s/_ksm_uksm=\"[^\"]*\"/_ksm_uksm=\"true\"/g
	s/_bcachefs=\"[^\"]*\"/_bcachefs=\"true\"/g
	s/_bfqmq=\"[^\"]*\"/_bfqmq=\"true\"/g
	s/_processor_opt=\"[^\"]*\"/_processor_opt=\"generic\"/g
	s/_smt_nice=\"[^\"]*\"/_smt_nice=\"true\"/g
	s/_random_trust_cpu=\"[^\"]*\"/_random_trust_cpu=\"true\"/g
	s/_runqueue_sharing=\"[^\"]*\"/_runqueue_sharing=\"mc\"/g
	s/_timer_freq=\"[^\"]*\"/_timer_freq=\"750\"/g
	s/_user_patches=\"[^\"]*\"/_user_patches=\"false\"/g
	" customization.cfg

	echo '[build-tkg] applied kernel customization'
	
	export TARGET_EXTRAPKGS='ccache'
}

wine_makepkg() {
	export TARGET_UPPER='wine'
	export TARGET_NUKE=0
	export TARGET_EXTRAPKGS='ccache zapcc'
        ~/chaotic-makepkg \
		--noconfirm --sign \
                $@
	~/chaotic-add
}

# Clone TKG
cd /tmp
rm -rf TkG
git clone https://github.com/Tk-Glitch/PKGBUILDS.git TkG
cd TkG

# Build Wine
if [ -z "$TKG_NOWINE" ]; then
cd wine-tkg-git
for VARIATION in 'false false false false' 'false true false false' 'true true false false' 'true false false false' 'false false true false' 'true false true false' 'false false false true' 'false true false true' 'true true false true' 'true false false true' 'false false true true' 'true false true true'
do
	git reset --hard HEAD
	git clean -dfx
	
	wine_setup $VARIATION
	rm -rf ./src
	
	wine_makepkg -sC 2>&1 | tee "$TKGLOGS/$_PKGNAME.log"
	
	sed -i'' "
	s/_EXTERNAL_INSTALL=\"[^\"]*\"/_EXTERNAL_INSTALL=\"true\"/g
	s/_EXTERNAL_INSTALL_TYPE=\"[^\"]*\"/_EXTERNAL_INSTALL_TYPE=\"opt\"/g
	" customization.cfg
	
	echo "[build-tkg] customization setted to: ${_PKGNAME/%-git/-opt-git}"

	export _OPT_PKGNAME="${_PKGNAME/%-git/-opt-git}"
	ln -srf "src/${_PKGNAME}-32-build" "src/${_OPT_PKGNAME}-32-build"
	ln -srf "src/${_PKGNAME}-64-build" "src/${_OPT_PKGNAME}-64-build"
	
	wine_makepkg -Rc 2>&1 | tee "$TKGLOGS/$_OPT_PKGNAME.log"
done

git checkout customization.cfg PKGBUILD
unset TARGET_UPPER TARGET_NUKE TARGET_EXTRAPKGS
cd ..
fi

# Build Proton
#if [ -z "$TKG_NOPROTON" ]; then
#cd proton-tkg
#export MAKEPKG=$HOME/chaotic-makepkg --sign --noconfirm -C
#./proton-tkg.sh
#~/chaotic-add
#unset MAKEPKG
#cd ..
#fi

# Build Linux
if [ -z "$TKG_NO420" ]; then
cd linux420-tkg
kernel_setup
~/chaotic-makepkg --sign --noconfirm -C 2>&1 | tee "$TKGLOGS/linux42.log"
~/chaotic-add
unset TARGET_EXTRAPKGS
cd ..
fi

if [ -z "$TKG_NO50" ]; then
cd linux50-tkg
kernel_setup
~/chaotic-makepkg --sign --noconfirm -C 2>&1 | tee "$TKGLOGS/linux50.log"
~/chaotic-add
unset TARGET_EXTRAPKGS
fi

# Clean anything else
echo '[build-tkg] Nuking everything'
cd /tmp
sudo rm -rf TkG
